name: React Web App CI/CD Deploy

on:
  push:
    branches:
      - main # Uruchamiany przy ka偶dym pushu do gazi main

jobs:
  build_and_deploy:
    # U偶ywamy maszyny Linux (Ubuntu) do budowania aplikacji webowej, jest to szybsze i tasze ni偶 macOS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Krok 1: Konfiguracja i Cache Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Upewnij si, 偶e to jest wersja u偶ywana w Twoim projekcie
          cache: 'npm'       # Wczenie cachowania zale偶noci (znacznie przyspiesza buildy)

      # Krok 2: Instalacja zale偶noci
      - name: Install Dependencies
        run: npm install

      # Krok 3: Budowanie aplikacji React (Kluczowy krok CI)
      - name: Build React Application
        run: npm run build
        # Aplikacja React zostanie skompilowana do katalogu 'build' lub 'dist'
        
      # Krok 4: Przesyanie skompilowanych plik贸w na VPS (Deployment - CD)
      # U偶ywamy rsync do wydajnego wgrywania tylko zmienionych plik贸w
      - name: Deploy with rsync to OVH VPS
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          
          #  SKD: Katalog wyjciowy po buildzie Reacta (najczciej 'build')
          SOURCE: "build/"
          #  DOKD: Katalog, kt贸ry serwuje Tw贸j webserwer (np. Nginx/Apache)
          TARGET: ${{ secrets.SSH_TARGET_DIR }}
          
          # Opcja 'exclude' i 'args' s bardzo wa偶ne dla bezpiecznego deploymentu
          ARGS: "--delete" # Usuwa pliki na serwerze, kt贸re zostay usunite w repo

      # Krok 5: Skrypty po wgraniu (Opcjonalne, jeli masz backend Node.js)
      # Ten krok jest potrzebny TYLKO, jeli masz backend Node.js, kt贸ry musisz zrestartowa.
      - name: Run post-deployment scripts (if needed)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Puste, jeli to tylko statyczny React.
            echo "Deployment statycznej aplikacji React zakoczony."
            # Jeli masz backend Node.js (np. Express):
            # cd /sciezka/do/backendu
            # pm2 restart nazwa-twojego-backendu || true
